@page "/iframe-host"
@using SharedBlazor
@using global::Shared
@inject IJSRuntime JS
@inject IIframeEventBus Bus

<h1>Host: Iframe Embed</h1>

<button @onclick="SendLinks">Send links:update</button>
<button @onclick="TellIframeNavigate">Send nav:go (/orders/42)</button>

<p><b>Status:</b> @_status</p>
<pre style="background:#f6f6f6;padding:12px;border:1px solid #ddd;white-space:pre-wrap;">@_lastEvent</pre>

<iframe @ref="_iframe" src="@IframeUrl" style="width:100%;height:520px;border:1px solid #ccc;"></iframe>

@code {
  private ElementReference _iframe;
  private IIframeEventBus? _bus;
  private IJSObjectReference? _busModule;

  private string _status = "Initializing…";
  private string _lastEvent = "(none)";

  private const string IframeOrigin = "http://localhost:6002";
  private const string IframeUrl = "http://localhost:6002/iframe-client";

  private bool _iframeReady;

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (!firstRender) return;

    // 1️⃣ Cargar módulo JS
    var module = await JS.InvokeAsync<IJSObjectReference>(
    "import",
    "./iframeBusInterop.js"
    );

    // 2️⃣ Registrar iframe DOM
    await module.InvokeVoidAsync("registerIframe", _iframe);

    // 3️⃣ Registrar handlers UNA sola vez
    Bus.Register<ReadyPayload>("ready");
    Bus.Register<LinkClicked>("link:clicked");
    Bus.Register<NavRequest>("nav:request");

    Bus.On<ReadyPayload>("ready", p =>
    {
      _status = $"Iframe ready: {p.App} {p.Version}";
      _lastEvent = "ready";
      StateHasChanged();
      return Task.CompletedTask;
    });

    Bus.On<LinkClicked>("link:clicked", p =>
    {
      _lastEvent = $"link clicked: {p.Href}";
      StateHasChanged();
      return Task.CompletedTask;
    });

    Bus.On<NavRequest>("nav:request", p =>
    {
      _lastEvent = $"nav request: {p.Href}";
      StateHasChanged();
      return Task.CompletedTask;
    });

    // 4️⃣ Arrancar el bus (solo una vez)
    await Bus.StartAsync(new[] { IframeOrigin });

    _status = "Listening…";


  }

  private async Task SendLinks()
  {
    var payload = new LinksUpdate(new[]
    {
new LinkDto("Orders (iframe route)", "/orders"),
new LinkDto("Order #42 (iframe route)", "/orders/42"),
new LinkDto("External: Microsoft", "https://www.microsoft.com")
});

    await Bus.PublishToIframeAsync(
    "links:update",
    payload,
    IframeOrigin
    );

    _lastEvent = "host -> iframe: links:update";
  }



  private async Task TellIframeNavigate()
  {
    await Bus.PublishToIframeAsync(
    "nav:go",
    new NavGo("/orders/42", false),
    IframeOrigin
    );

    _lastEvent = "host -> iframe: nav:go";

  }
}