@page "/iframe-client"
@using SharedBlazor
@using global::Shared
@inject IJSRuntime JS
@inject NavigationManager Nav


@inject IIframeEventBus Bus

<h1>Iframe: Client</h1>
<p><b>Status:</b> @_status</p>

@if (_links.Count == 0)
{
  <p>(No links yet — click “Send links:update” in host.)</p>
}
else
{
  <ul>
    @foreach (var l in _links)
    {
      <li>
        <a href="" @onclick="() => OnLinkClicked(l)">@l.Text</a>
        <span style="color:#888;"> — @l.Href</span>
      </li>
    }
  </ul>
}

<hr />
<p>Iframe routes:</p>
<ul>
  <li><a href="/orders">/orders</a></li>
  <li><a href="/orders/42">/orders/42</a></li>
</ul>

@code {
  private string _status = "Initializing…";
  private List<LinkDto> _links = new();
  private const string HostOrigin = "http://localhost:6001";

  protected override void OnInitialized()
  {
    Bus.Register<NavGo>("nav:go");

    Bus.On<NavGo>("nav:go", p =>
    {
      Nav.NavigateTo(p.Href, p.ForceLoad);
      return Task.CompletedTask;
    });


    Bus.Register<LinksUpdate>("links:update");


    Bus.On<LinksUpdate>("links:update", p =>
    {
      _links = p.Links.ToList();
      _status = $"Received links:update ({_links.Count})";
      StateHasChanged();
      return Task.CompletedTask;
    });

    Bus.PublishToParentAsync(
    "ready",
    new ReadyPayload("iframe", "1.0.0"),
    HostOrigin
    );

    _status = "Ready (sent ready -> host)";

  }

  private async Task OnLinkClicked(LinkDto link)
  {
    if (Bus is null) return;
    await Bus.PublishToParentAsync(
    "link:clicked",
    new LinkClicked(link.Href),
    HostOrigin
    );

    if (link.Href.StartsWith("/"))
    {
      Nav.NavigateTo(link.Href);
      _status = $"Navigated inside iframe: {link.Href}";
    }
    else
    {
      await Bus.PublishToParentAsync(
      "nav:request",
      new NavRequest(link.Href),
      HostOrigin
      );
      _status = $"Requested host navigate: {link.Href}";
    }

    StateHasChanged();
  }
}